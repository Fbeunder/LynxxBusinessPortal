{% extends "base.html" %}

{% block title %}Lynxx Business Portal - Admin{% endblock %}

{% block extra_head %}
<style>
    .admin-container {
        margin: 2rem 0;
    }
    
    .admin-section {
        background-color: white;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    
    .admin-title {
        margin-bottom: 1.5rem;
        border-bottom: 1px solid #eee;
        padding-bottom: 1rem;
    }
    
    .app-list {
        margin-bottom: 2rem;
    }
    
    .app-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        border: 1px solid #eee;
        border-radius: 4px;
        margin-bottom: 0.5rem;
        transition: background-color 0.2s;
    }
    
    .app-item:hover {
        background-color: #f9f9f9;
    }
    
    .app-name {
        font-weight: bold;
    }
    
    .app-url {
        color: #666;
        font-size: 0.9rem;
    }
    
    .app-actions {
        display: flex;
        gap: 10px;
    }
    
    .admin-form {
        background-color: #f9f9f9;
        padding: 1.5rem;
        border-radius: 4px;
        margin-top: 1.5rem;
    }
    
    .form-group {
        margin-bottom: 1rem;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: bold;
    }
    
    .form-control {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    
    .form-buttons {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 1.5rem;
    }
    
    .btn-primary {
        background-color: #007bff;
    }
    
    .btn-danger {
        background-color: #dc3545;
    }
    
    .btn-secondary {
        background-color: #6c757d;
    }
    
    .hidden {
        display: none;
    }
    
    .status-message {
        padding: 1rem;
        margin: 1rem 0;
        border-radius: 4px;
    }
    
    .status-success {
        background-color: #d4edda;
        color: #155724;
    }
    
    .status-error {
        background-color: #f8d7da;
        color: #721c24;
    }

    .drag-handle {
        cursor: grab;
        color: #999;
        margin-right: 10px;
    }

    .app-item.dragging {
        opacity: 0.5;
        border: 2px dashed #007bff;
    }
</style>
{% endblock %}

{% block content %}
<div class="admin-container">
    <h2>Admin Dashboard</h2>
    <p>Welkom bij het admin dashboard van de Lynxx Business Portal. Hier kun je apps beheren.</p>
    
    <div class="admin-section">
        <h3 class="admin-title">Apps Beheren</h3>
        
        <div id="status-message" class="hidden status-message"></div>
        
        <div class="app-list" id="app-list">
            {% for app in apps %}
            <div class="app-item" data-id="{{ loop.index0 }}">
                <div class="app-info">
                    <span class="drag-handle">â˜°</span>
                    <span class="app-name">{{ app.name }}</span> - 
                    <span class="app-url">{{ app.url }}</span>
                    <div class="app-description">{{ app.description }}</div>
                </div>
                <div class="app-actions">
                    <button class="btn btn-secondary edit-app" data-id="{{ loop.index0 }}">Bewerken</button>
                    <button class="btn btn-danger delete-app" data-id="{{ loop.index0 }}">Verwijderen</button>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <button id="add-app-btn" class="btn btn-primary">Nieuwe App Toevoegen</button>
        
        <div id="app-form" class="admin-form hidden">
            <h4 id="form-title">App Toevoegen</h4>
            <form id="app-edit-form">
                <input type="hidden" id="app-id" value="">
                
                <div class="form-group">
                    <label for="app-name">Naam:</label>
                    <input type="text" id="app-name" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label for="app-url">URL:</label>
                    <input type="url" id="app-url" class="form-control" required placeholder="https://...">
                </div>
                
                <div class="form-group">
                    <label for="app-description">Beschrijving:</label>
                    <textarea id="app-description" class="form-control" rows="3" required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="app-icon">Icon (naam of emoji):</label>
                    <input type="text" id="app-icon" class="form-control" placeholder="bijv. 'mail' of 'ðŸ“§'">
                </div>
                
                <div class="form-buttons">
                    <button type="button" id="cancel-btn" class="btn btn-secondary">Annuleren</button>
                    <button type="submit" class="btn btn-primary">Opslaan</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Elements
    const appList = document.getElementById('app-list');
    const addAppBtn = document.getElementById('add-app-btn');
    const appForm = document.getElementById('app-form');
    const appEditForm = document.getElementById('app-edit-form');
    const formTitle = document.getElementById('form-title');
    const cancelBtn = document.getElementById('cancel-btn');
    const statusMessage = document.getElementById('status-message');
    
    // Form inputs
    const appIdInput = document.getElementById('app-id');
    const appNameInput = document.getElementById('app-name');
    const appUrlInput = document.getElementById('app-url');
    const appDescriptionInput = document.getElementById('app-description');
    const appIconInput = document.getElementById('app-icon');
    
    // App data
    let apps = {{ apps|tojson }};
    
    // Add new app button click
    addAppBtn.addEventListener('click', function() {
        formTitle.textContent = 'App Toevoegen';
        appIdInput.value = '';
        appNameInput.value = '';
        appUrlInput.value = '';
        appDescriptionInput.value = '';
        appIconInput.value = '';
        appForm.classList.remove('hidden');
    });
    
    // Cancel button click
    cancelBtn.addEventListener('click', function() {
        appForm.classList.add('hidden');
    });
    
    // Edit app buttons
    document.querySelectorAll('.edit-app').forEach(button => {
        button.addEventListener('click', function() {
            const appId = this.getAttribute('data-id');
            const app = apps[appId];
            
            formTitle.textContent = 'App Bewerken';
            appIdInput.value = appId;
            appNameInput.value = app.name;
            appUrlInput.value = app.url;
            appDescriptionInput.value = app.description;
            appIconInput.value = app.icon || '';
            
            appForm.classList.remove('hidden');
        });
    });
    
    // Delete app buttons
    document.querySelectorAll('.delete-app').forEach(button => {
        button.addEventListener('click', function() {
            if (confirm('Weet je zeker dat je deze app wilt verwijderen?')) {
                const appId = this.getAttribute('data-id');
                deleteApp(appId);
            }
        });
    });
    
    // Form submit
    appEditForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const appData = {
            name: appNameInput.value,
            url: appUrlInput.value,
            description: appDescriptionInput.value,
            icon: appIconInput.value
        };
        
        const appId = appIdInput.value;
        if (appId === '') {
            // Add new app
            addApp(appData);
        } else {
            // Update existing app
            updateApp(appId, appData);
        }
    });
    
    // Add a new app
    function addApp(appData) {
        fetch('/admin/apps', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(appData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showStatusMessage('App succesvol toegevoegd!', 'success');
                appForm.classList.add('hidden');
                // Reload page to show updated app list
                setTimeout(() => window.location.reload(), 1000);
            } else {
                showStatusMessage(`Fout: ${data.message}`, 'error');
            }
        })
        .catch(error => {
            showStatusMessage(`Error: ${error.message}`, 'error');
        });
    }
    
    // Update an existing app
    function updateApp(appId, appData) {
        fetch(`/admin/apps/${appId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(appData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showStatusMessage('App succesvol bijgewerkt!', 'success');
                appForm.classList.add('hidden');
                // Reload page to show updated app list
                setTimeout(() => window.location.reload(), 1000);
            } else {
                showStatusMessage(`Fout: ${data.message}`, 'error');
            }
        })
        .catch(error => {
            showStatusMessage(`Error: ${error.message}`, 'error');
        });
    }
    
    // Delete an app
    function deleteApp(appId) {
        fetch(`/admin/apps/${appId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showStatusMessage('App succesvol verwijderd!', 'success');
                // Reload page to show updated app list
                setTimeout(() => window.location.reload(), 1000);
            } else {
                showStatusMessage(`Fout: ${data.message}`, 'error');
            }
        })
        .catch(error => {
            showStatusMessage(`Error: ${error.message}`, 'error');
        });
    }
    
    // Utility function to show status messages
    function showStatusMessage(message, type) {
        statusMessage.textContent = message;
        statusMessage.className = `status-message status-${type}`;
        statusMessage.classList.remove('hidden');
        setTimeout(() => {
            statusMessage.classList.add('hidden');
        }, 5000);
    }

    // App reordering functionality with drag and drop
    let draggedItem = null;
    
    // Set up drag and drop events for app items
    document.querySelectorAll('.app-item').forEach(item => {
        // Drag start
        item.addEventListener('dragstart', function(e) {
            draggedItem = this;
            setTimeout(() => {
                this.classList.add('dragging');
            }, 0);
        });
        
        // Drag end
        item.addEventListener('dragend', function() {
            this.classList.remove('dragging');
            saveNewOrder();
        });
        
        // Make draggable
        item.setAttribute('draggable', 'true');
        
        // Drag over
        item.addEventListener('dragover', function(e) {
            e.preventDefault();
            if (draggedItem !== this) {
                const rect = this.getBoundingClientRect();
                const y = e.clientY - rect.top;
                
                if (y < rect.height / 2) {
                    appList.insertBefore(draggedItem, this);
                } else {
                    appList.insertBefore(draggedItem, this.nextSibling);
                }
            }
        });
    });
    
    // Save the new app order
    function saveNewOrder() {
        const newOrder = [];
        document.querySelectorAll('.app-item').forEach(item => {
            const appId = item.getAttribute('data-id');
            newOrder.push(parseInt(appId));
        });
        
        fetch('/admin/apps/reorder', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ order: newOrder })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showStatusMessage('App volgorde bijgewerkt!', 'success');
            } else {
                showStatusMessage(`Fout: ${data.message}`, 'error');
            }
        })
        .catch(error => {
            showStatusMessage(`Error: ${error.message}`, 'error');
        });
    }
});
</script>
{% endblock %}
